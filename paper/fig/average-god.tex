\documentclass[tikz,border=2pt]{standalone}
\input{../preamble.tex}
\input{tikz_shapes.tex}
\pagestyle{empty}

\begin{document}
\begin{tikzpicture}[x=2cm,y=2cm]
    \SetupGodunov
    
    % 2. Calculate New Heights (Using PGF Math, not Text replacement)
    % We group variables in (...) to ensure safety against text expansion order
    \pgfmathsetmacro{\hLn}{0.8 * \hL}
    \pgfmathsetmacro{\hMn}{(\dt * \hL) + (\hM - \dt * \hM)}
    \pgfmathsetmacro{\hRn}{(\dt * \hM) + (\hR - \dt * \hR)}

    % 3. Draw
    \foreach \pos / \oldH / \newH / \idx in {
        -\dx / \hL / \hLn / {i-1},
         0   / \hM / \hMn / {i},
         \dx / \hR / \hRn / {i+1}
    } {
        % Draw New Average (Solid Fill)
        \fill[old values] (\pos,0) rectangle +(\dx,\newH);
        
        % Draw Old Average Shifted (Dashed Outline)
        % This shows where the mass came from
        \draw[dashed] (\pos+\dt, 0) rectangle +(\dx, \oldH);

        % Label
        \node at (\pos+0.2*\dx, \newH+.1*\dx) {$u_\idx^{n+1}$};
    }
    \node[explanation godunov] at (3*\dx, \hM) {
        \textbf{Step 3: Averaging}\\
        The new cell average is computed by integrating the evolved solution:
    \[
        u_{i}^{n+1} = \frac{1}{\Delta x} \int_{x_{i - 1/2}}^{x_{i + 1/2}} \tilde{u}(x,t^{n+1}) \,\mathrm{d}x.
    \]
    };
\end{tikzpicture}
\end{document}
