\documentclass[tikz,border=2pt]{standalone}

% Needed for standalone compilation of fig/*.tex
\IfFileExists{../preamble.tex}
{\input{../preamble.tex}}% If compiling *.tex directly
{\input{preamble.tex}}% If compiling main.tex

\IfFileExists{tikz-shapes.tex}
{\input{tikz-shapes.tex}}
{\input{fig/tikz-shapes.tex}}

\pagestyle{empty}

\usetikzlibrary{calc,babel}

\begin{document}
\begin{tikzpicture}[x=2cm,y=2cm]
    \begin{scope}[shift={(-\dt,0)}]
    \DrawFVGrid
    \end{scope}
    \SetupAvgs

    \def\hM{.85*\dx}
    \coordinate (cM) at (.5*\dx,\hM);

    \def\hRn{1.25*\dx}
    \coordinate (cRn) at (\dx+.5*\dx-\dt,\hRn);

    \foreach \pos / \id / \idx in {-\dx/L/{i-1}, 0/M/{i}, \dx/R/{i+1}} {
            
            % 1. CONSTRUCT NAMES
            % \edef forces expansion immediately: "c" + "L" + "n" -> "cLn"
            \edef\leftPoint{c\id n}
            \edef\rightPoint{c\id}

            % 2. ALIAS
            \path (\leftPoint) coordinate (A) (\rightPoint) coordinate (B);

            % 3. FILL (Trapezoid)
            \fill[old values] 
                (\pos, 0) -- 
                (\pos+\dx, 0) -- 
                (intersection of A--B and \pos+\dx,0 -- \pos+\dx, 10) -- 
                node[slope text] {$\sigma_{\idx}$}
                (intersection of A--B and \pos,0 -- \pos,10) -- cycle;

            % 4. DRAW (Flux Shift)
            \draw[dashed, newcolor] 
                (intersection of A--B and \pos,0 -- \pos,10) -- 
                (intersection of A--B and \pos-\dt,0 -- \pos-\dt,10) -- 
                (\pos-\dt, 0);
        }
        \draw[dashed,newcolor]
            (intersection of A--B and 2*\dx-\dt,0 -- 2*\dx-\dt,10) --
            (2*\dx-\dt,0);

        % Draw
        \foreach \pos / \oldH / \newH / \idx in {
            -\dx / \hL / \hLn / {i-1},
             0   / \hM / \hMn / {i},
             \dx / \hR / \hRn / {i+1}
        } {
            \filldraw[avg dot] (\pos + 0.5*\dx, \oldH) circle (\dotSize);
            \node[avg text] at (\pos+0.5*\dx, \oldH+.1*\dx) {$u_\idx^{n}$};

            \DrawTick[newcolor]{\pos-\dt,0};
            \filldraw[new avg dot] (\pos + 0.5*\dx-\dt, \newH) circle (\dotSize);
            \node[new avg text] at (\pos+0.5*\dx-\dt, \newH+.1*\dx) {$u_\idx^{n+1}$};
        }

        \DrawTick[newcolor]{2*\dx-\dt,0};

        % Fluxes
        % Out
        \fill[flux area]
            (\dx-\dt, 0) -- 
            (\dx, 0) -- 
            (intersection of cMn--cM and \dx,0 -- \dx, 10) -- 
            (intersection of cMn--cM and \dx-\dt,0 -- \dx-\dt,10) -- cycle;
        \node[flux text] at (\dx-\dt/2, \hMn/2) {Out};

        % Out
        \fill[flux area]
            (-\dt, 0) -- 
            (0, 0) -- 
            (intersection of cLn--cL and 0,0 -- 0, 10) -- 
            (intersection of cLn--cL and -\dt,0 -- -\dt,10) -- cycle;
        \node[flux text] at (-\dt/2, \hLn/2) {In};

\end{tikzpicture}
\end{document}
