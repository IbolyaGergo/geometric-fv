\documentclass[tikz,border=2pt]{standalone}

% Needed for standalone compilation of fig/*.tex
\IfFileExists{../preamble.tex}
{\input{../preamble.tex}}% If compiling *.tex directly
{\input{preamble.tex}}% If compiling main.tex

\IfFileExists{tikz_shapes.tex}
{\input{tikz_shapes.tex}}
{\input{fig/tikz_shapes.tex}}

\pagestyle{empty}

\begin{document}%
\begin{tikzpicture}[x=2cm,y=2cm]
    \SetupLinear

    \foreach \pos \avg \s \edgeR \edgeL \idx in {
        -\dx / \hL / \sL / \edgeLR / \edgeLL / {i-1},
        0    / \hM / \sM / \edgeMR / \edgeML / {i},  
        \dx  / \hR / \sR / \edgeRR / \edgeRL / {i+1} 
    } {
        % Evolved values
        \fill[old values]
            (\pos+\dt, 0) --
            (\pos+\dx+\dt, 0) --
            (\pos+\dx+\dt, \edgeR) --
            (\pos+\dt, \edgeL) -- cycle;

        % Ghost values
        \draw[dashed]
            (\pos, 0) --
            (\pos, \edgeL) --
            (\pos+\dx, \edgeR);

        \draw (\pos+\dt,\edgeL) --
            node[slope text] {$\sigma_{\idx}$}
            (\pos+\dx+\dt,\edgeR);

        \filldraw[avg dot] (\pos + 0.5*\dx+\dt, \avg) circle (\dotSize);

        \node[avg text] at (\pos+0.45*\dx+\dt, \avg + 0.2) {$u_\idx^n$};
    }

    \draw[dashed] (2*\dx,0) -- +(0,\edgeRR);

    % Swept area
    \pgfmathsetmacro{\edgeLRmdt}{\edgeLR - \sL*(\dt)}
    \pgfmathsetmacro{\edgeMRmdt}{\edgeMR - \sM*(\dt)}

    \fill[flux area]
        (0,0) -- +(\dt,0) -- +(\dt,\edgeLR) -- +(0,\edgeLRmdt) -- cycle;
    \node[flux text] at (\dt/2, \hL/2) {In};

    \fill[flux area]
        (\dx,0) -- +(\dt,0) -- +(\dt,\edgeMR) -- +(0,\edgeMRmdt) -- cycle;
    \node[flux text] at (\dx+\dt/2, \hM/2) {Out};

    \draw[->] (0, \hM+.1*\dx) -- (\dt, \hM+.1*\dx) node[midway, above] {$a\Delta t$};

\end{tikzpicture}
\end{document}

